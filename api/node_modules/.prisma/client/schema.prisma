generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CaseStatus {
  ACTIVE
  ARCHIVED
  PENDING_DELETE
}

enum DocumentSource {
  EMAIL
  MANUAL
}

model User {
  id            String         @id
  username      String         @unique
  role          String
  createdAt     DateTime       @default(now())
  cases         Case[]
  notifications Notification[]
}

model Case {
  id                        String     @id @default(uuid())
  ownerId                   String
  title                     String
  topicSummary              String     @default("")
  data                      Json       @default("{}")
  status                    CaseStatus @default(ACTIVE)
  createdAt                 DateTime   @default(now())
  updatedAt                 DateTime   @updatedAt
  lastAccessedAt            DateTime?
  retentionExpiresAt        DateTime   @default(now())
  archivedAt                DateTime?
  retentionWarningSent      Boolean    @default(false)
  retentionFinalWarningSent Boolean    @default(false)

  owner              User                @relation(fields: [ownerId], references: [id])
  knowledgeDocuments KnowledgeDocument[]
  notifications      Notification[]
}

model AuditEvent {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String?
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
}

model KnowledgeDocument {
  id                  String   @id @default(uuid())
  sourceFile          String
  docType             String
  title               String
  summary             String
  sections            Json
  claims              Json
  flags               Json
  score               Json
  timeline            Json     @default("[]")
  qualityFindings     Json     @default("[]")
  medicalQualityScore Int      @default(0)
  literatureQueries   Json     @default("[]")
  reasoningFindings   Json     @default("[]")
  ocrMode             String   @default("base")
  ocrLexicalMap       Json
  insights            Json
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  caseId String?

  case                Case?                @relation(fields: [caseId], references: [id], onDelete: SetNull)
  literatureResources LiteratureResource[]
}

model LiteratureResource {
  id                 String    @id @default(uuid())
  knowledgeId        String
  doi                String?
  pmid               String?
  title              String
  authors            Json
  journal            String?
  year               Int?
  source             String?
  url                String?
  oaStatus           String    @default("unknown")
  oaUrl              String?
  oaPdfUrl           String?
  pmcId              String?
  pmcUrl             String?
  license            String?
  oaCheckedAt        DateTime?
  downloadStatus     String    @default("pending")
  localPath          String?
  downloadedAt       DateTime?
  summaryJson        Json?
  linkedClaimIds     Json      @default("[]")
  summaryQuality     String    @default("unknown")
  summaryQualityNote String?
  fetchedAt          DateTime  @default(now())

  knowledgeDocument KnowledgeDocument @relation(fields: [knowledgeId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  message   String
  metadata  Json?     @default("{}")
  caseId    String?
  readAt    DateTime?
  createdAt DateTime  @default(now())

  case Case? @relation(fields: [caseId], references: [id], onDelete: SetNull)
  user User  @relation(fields: [userId], references: [id])
}

model Document {
  id         String         @id
  title      String
  summary    String         @default("")
  content    String? // extracted text (for free-text search); may be null
  categoryId String
  category   Category       @relation(fields: [categoryId], references: [id])
  keywords   String[]       @default([])
  topics     String[]       @default([])
  source     DocumentSource

  emailFrom      String?
  emailSubject   String?
  emailDate      DateTime?
  emailMessageId String?   @unique

  attachmentUrl  String?
  attachmentMime String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id        String     @id @default(cuid())
  name      String     @unique
  documents Document[]
}

model EmailIngestionState {
  mailbox   String   @id
  lastUid   BigInt   @default(0)
  updatedAt DateTime @updatedAt
}
